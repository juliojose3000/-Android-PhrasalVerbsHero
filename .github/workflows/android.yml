name: Android CI/CD

on:
  push:
    branches:
      - main
      - release/v*
      - tests/v*
  pull_request:
    branches: [ "*" ]

jobs:
  build_apk:
    name: üîß Build APK
    runs-on: ubuntu-latest

    env:
      PROJECT_LOCATION: .
      MODULE: app
      QA_VARIANT: qaRelease

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: üõ†Ô∏è Make Gradle executable
        run: chmod +x ${{ env.PROJECT_LOCATION }}/gradlew

      - name: üì¶ Build APK
        run: ./gradlew :${{ env.MODULE }}:assemble${{ env.QA_VARIANT }}

      - name: ‚úÖ Run Lint
        run: ./gradlew lint${{ env.QA_VARIANT }}

      - name: üß™ Run Unit Tests
        run: ./gradlew :${{ env.MODULE }}:test${{ env.QA_VARIANT }}UnitTest

      - name: üîè Sign APK (if needed)
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo $KEYSTORE_BASE64 | base64 -d > my-keystore.jks
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore my-keystore.jks -storepass $KEYSTORE_PASSWORD -keypass $KEY_PASSWORD \
            ${{ env.PROJECT_LOCATION }}/${{ env.MODULE }}/build/outputs/apk/qa/release/app-qa-release-unsigned.apk \
            $KEY_ALIAS

      - name: üöÄ Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: 1:238622179168:android:24853bdfaec1206d776805
          token: ${{ secrets.FIREBASE_TOKEN }}
          groups: development
          releaseNotes: ${{ github.event.head_commit.message }}
          file: ${{ env.PROJECT_LOCATION }}/${{ env.MODULE }}/build/outputs/apk/qa/release/app-qa-release-unsigned.apk

  run_tests:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    env:
      PROJECT_LOCATION: .
      MODULE: app
      VARIANT: qaDebug

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: üõ†Ô∏è Make Gradle executable
        run: chmod +x ${{ env.PROJECT_LOCATION }}/gradlew

      - name: üß™ Run Unit Tests
        run: ./gradlew :${{ env.MODULE }}:test${{ env.VARIANT }}UnitTest

      - name: üì§ Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-report
          path: ${{ env.PROJECT_LOCATION }}/${{ env.MODULE }}/build/reports/tests/
